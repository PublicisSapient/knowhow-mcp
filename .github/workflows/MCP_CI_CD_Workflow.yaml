name: MCP_CI_CD_Workflow
on:
  workflow_dispatch:
    inputs:
      test:
        description: "Run tests"
        required: true
        default: "true"
        type: choice
        options:
          - "false"
          - "true"

      deploy:
        description: "Do you want to deploy after build?"
        required: true
        default: "true"
        type: choice
        options:
          - "false"
          - "true"

      env:
        description: "Environment to deploy"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - dev1
          - qa
          - stage

env:
  IMAGE_NAME: knowhow-mcp
  ACR_NAME: ${{ secrets.SPEEDTOOLS_ACR_NAME }}
  ACR_LOGIN_SERVER: ${{ secrets.SPEEDTOOLS_ACR_LOGIN_SERVER }}
  BITBUCKET_HELM_REPO: ${{ secrets.SPEEDTOOLS_BITBUCKET_HELM_REPO }}
  sonartoken: ${{ secrets.SONARQUBE_TOKEN }}
  sonarurl: ${{ secrets.SONARURL }}
  GITHUB_HEAD_NAME: $GITHUB_HEAD_REF

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      argocd_app_name: ${{ steps.set_env.outputs.argocd_app_name }}
    steps:
      - name: Set IMAGE_TAG and values file
        id: set_env
        run: |
          ENV="${{ github.event.inputs.env }}"
          if [[ "$ENV" == "qa" ]]; then
            echo "IMAGE_TAG=qa-${GITHUB_SHA::8}" >> $GITHUB_ENV
            echo "VALUES_FILE=values-qa.yaml" >> $GITHUB_ENV
            echo "ARGOCD_APP_NAME=knowhow-mcp-qa" >> $GITHUB_ENV
            echo "argocd_app_name=knowhow-mcp-qa" >> $GITHUB_OUTPUT
          elif [[ "$ENV" == "stage" ]]; then
            echo "IMAGE_TAG=master-${GITHUB_SHA::8}" >> $GITHUB_ENV
            echo "VALUES_FILE=values-stage.yaml" >> $GITHUB_ENV
            echo "ARGOCD_APP_NAME=knowhow-mcp-stage" >> $GITHUB_ENV
            echo "argocd_app_name=knowhow-mcp-stage" >> $GITHUB_OUTPUT
          elif [[ "$ENV" == "dev1" ]]; then
            echo "IMAGE_TAG=dev1-${GITHUB_SHA::8}" >> $GITHUB_ENV
            echo "VALUES_FILE=values-dev1.yaml" >> $GITHUB_ENV
            echo "ARGOCD_APP_NAME=knowhow-mcp-dev1" >> $GITHUB_ENV
            echo "argocd_app_name=knowhow-mcp-dev1" >> $GITHUB_OUTPUT
          else
            echo "IMAGE_TAG=dev-${GITHUB_SHA::8}" >> $GITHUB_ENV
            echo "VALUES_FILE=values-dev.yaml" >> $GITHUB_ENV
            echo "ARGOCD_APP_NAME=knowhow-mcp-dev" >> $GITHUB_ENV
            echo "argocd_app_name=knowhow-mcp-dev" >> $GITHUB_OUTPUT
          fi

      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Print Selected Deployment Parameters
        run: |
          echo "----- Deployment Parameters -----"
          echo "Selected Environment : ${{ github.event.inputs.env }}"
          echo "Run Tests            : ${{ github.event.inputs.test }}"
          echo "Deploy After Build   : ${{ github.event.inputs.deploy }}"
          echo "Deploying Branch     : ${{ github.head_ref || github.ref_name }}"
          echo "Git SHA              : $GITHUB_SHA"
          echo "--------------------------------"

      - name: Set Up Java
        uses: actions/setup-java@v2
        with:
          distribution: "adopt"
          java-version: "17"

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build knowhow-mcp
        run: mvn clean install -Ddockerfile.skip=true

      - name: Build & Push Docker Image
        run: |
          echo "Logging into ACR..."
          docker login $ACR_LOGIN_SERVER --username ${{ secrets.SPEEDTOOLS_ACR_USERNAME }} --password ${{ secrets.SPEEDTOOLS_ACR_PASSWORD }}
          echo "Building Docker image..."
          docker build -t $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG .
          echo "Pushing Docker image..."
          docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Checkout Helm charts from Bitbucket
        run: |
          git clone ${{ secrets.SPEEDTOOLS_BITBUCKET_HELM_REPO }}
          cd build-configurations/KnowHOW-Deploy/knowhow-mcp
          yq -i ".image.tag = \"${IMAGE_TAG}\"" $VALUES_FILE
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add $VALUES_FILE
          git diff --cached --quiet || git commit -m "Update image tag values to ${IMAGE_TAG}"
          git push origin HEAD

  deploy:
    if: ${{ github.event.inputs.deploy == 'true' }}
    runs-on: github-actions-self-hosted-runner
    timeout-minutes: 15
    needs: build
    env:
      ARGOCD_APP_NAME: ${{ needs.build.outputs.argocd_app_name }}
    steps:
      - name: Install ArgoCD CLI
        run: |
          export ARGO_PATH="$HOME/bin"
          mkdir -p $ARGO_PATH
          curl -sSL -o "$ARGO_PATH/argocd" \
            https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x "$ARGO_PATH/argocd"
          echo "$ARGO_PATH" >> $GITHUB_PATH

      - name: ArgoCD CLI Login
        run: |
          argocd login argocd-server \
            --username ${{ secrets.SPEEDTOOLS_ARGOCD_USERNAME}} \
            --password ${{ secrets.SPEEDTOOLS_ARGOCD_PASSWORD }} \
            --plaintext

      - name: Sync application
        id: sync-app
        run: argocd app sync ${{ env.ARGOCD_APP_NAME }}

      - name: Wait for application health
        run: argocd app wait ${{ env.ARGOCD_APP_NAME }} --health --timeout 300
